name: Activity Log Update

on:
  schedule:
    - cron: '0 12 * * *'  # Runs daily at 12:00 UTC
  workflow_dispatch:  # Allows manual trigger

jobs:
  commit-job:
    runs-on: ubuntu-latest
    steps:
      - name: Decide whether to run today
        id: decision
        run: |
          DECISION_ARRAY=(1 1 1 1 1 1 1 0 0 0) 
          RANDOM_PICK=${DECISION_ARRAY[$RANDOM % ${#DECISION_ARRAY[@]}]}
          
          if [[ $RANDOM_PICK -eq 0 ]]; then
            echo "Skipping today's run."
            echo "CONTINUE_RUN=false" >> $GITHUB_ENV
          else
            echo "Running update."
            echo "CONTINUE_RUN=true" >> $GITHUB_ENV
          fi

      - name: Select repository
        if: env.CONTINUE_RUN == 'true'
        run: |
          REPOS=("Fanpit-Backend" "PennyWise" "Skincare-Analysis-Frontend" "Trainify-A-Virtual-AI-Trainer" "sense-guard-monitor" "Underwater-Plastic-Detection")
          SELECTED_REPO=${REPOS[$RANDOM % ${#REPOS[@]}]}
          echo "SELECTED_REPO=$SELECTED_REPO" >> $GITHUB_ENV

      - name: Clone and Config
        if: env.CONTINUE_RUN == 'true'
        run: |
          # FIX 1: Use Token for Cloning (Fixes Private Repo access)
          git clone https://Abishek0411:${{ secrets.GH_PAT }}@github.com/Abishek0411/${{ env.SELECTED_REPO }}.git
          
          # FIX 2: Use ./ to handle repo names starting with hyphen (-)
          cd ./${{ env.SELECTED_REPO }}
          
          git config --global user.name "Abishek0411"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit and Push
        if: env.CONTINUE_RUN == 'true'
        run: |
          # Use ./ again for safety
          cd ./${{ env.SELECTED_REPO }}
          
          NUM_COMMITS=$(( RANDOM % 5 + 1 ))
          
          for i in $(seq 1 $NUM_COMMITS); do
            echo "$(date) - Activity Log Update $i" >> activity.log
            git add -f activity.log
            git commit -m "activity update $i on $(date)"
          done
          
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          
          # FIX 3: Authenticated Push using the PAT
          git push https://Abishek0411:${{ secrets.GH_PAT }}@github.com/Abishek0411/${{ env.SELECTED_REPO }}.git $CURRENT_BRANCH
